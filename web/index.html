<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Crafting Calculator GUI Live</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            table { border-collapse: collapse; width: 100%; }
            th, td { text-align: left; padding: 8px 8px 8px 0; }
            /* tr:nth-child(even) { background-color: #f2f2f2; } */
            .expandable-row { cursor: pointer; }
            /* .sub-table { width: 500px; margin-left: 20px; } */
            .sub-table { margin-left: 20px; }
            .sub-table-row > td { overflow: hidden; }
            .sub-table .table-header-row { display: none; }
            tr.sub-table-row { border-left: 1px solid #ccc; }
            tr.depth-0 { border-top: 1px solid #ccc; }

            /* .sub-table.depth-1 { width: 500px; }
            .sub-table.depth-2 { width: 490px; } */

            td.item-name { display: inline-block; }
            td.quantity { display: inline-block; }
            .sub-table .quantity input { border: none; }
            td.output-wrapper textarea { width: 100%; }
            
            /* tr.depth-0 .item-name { width: 400px; }
            tr.depth-1 .item-name { width: 280px; }
            
            tr.depth-0 .quantity { width: 100px; }
            tr.depth-1 .quantity { width: 110px; }
            tr.depth-2 .quantity { width: 120px; }
            tr.depth-3 .quantity { width: 130px; }
            tr.depth-4 .quantity { width: 140px; }
            tr.depth-5 .quantity { width: 150px; }
            tr.depth-6 .quantity { width: 160px; }
            tr.depth-7 .quantity { width: 170px; }
            tr.depth-8 .quantity { width: 180px; } */
            
            /* .output-wrapper { width: 30%; } */
            /* .output { width: 100%; } */
            /* .width30 { width: 400px; } */
            .no-expand td:first-child { padding-left: 2rem; }
            /* .rarity-green td:first-child { color: white; background-color: green; }
            .rarity-blue td:first-child { color: white; background-color: blue; }
            .rarity-purple td:first-child { color: white; background-color: purple; } */
            .rarity-green td:first-child { color: green; }
            .rarity-blue td:first-child { color: blue; }
            .rarity-purple td:first-child { color: purple; }
            span.expand-icon {
                color: orange;
                font-weight: 900;
                background-color: #eee;
                border: 1px solid orange;
                border-radius: 12px;
                padding: 0px 6px;
                margin-right: 5px;
                min-width: 11px;
                display: inline-block;
                text-align: center;
            }
        </style>
        <script>
            async function calculateTableList() {
                try {
                    const response = await fetch('data.json');
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const data = await response.json();

                    const tableBody = document.getElementById('js-data-table-list');
                    tableBody.innerHTML = '';

                    function createTableRow(item, depth = 0) {
                        // Define indentation and classes based on item properties
                        const indent = ' '.repeat(depth * 4);  // Indentation for nested rows
                        const rarityClass = item.rarity ? `rarity-${item.rarity.toLowerCase()}` : '';  // Class for rarity
                        const depthClass = `depth-${depth}`;
                        const subTableDepthClass = `depth-${depth + 1}`;
                        const source = item.source || '';
                        const wiki = item.wiki || '';

                        // Start building the row HTML
                        let rowHtml = `<tr class="${item.items ? 'expandable-row' : 'no-expand'} ${rarityClass} ${depthClass}" style="margin-left: ${indent};">`;

                        // Add item name cell with optional expand/collapse functionality
                        rowHtml += item.items
                            ? `<td class="item-name parent width30" onclick="toggleSubTable(this)" data-source="${source}" data-wiki="${wiki}">
                                   <span class="expand-icon">+</span>${item.name}
                               </td>`
                            : `<td class="item-name ${rarityClass} width30" data-source="${source}" data-wiki="${wiki}">${item.name}</td>`;

                        // Check if depth > 0 to conditionally add disabled attribute
                        const disabledAttr = depth > 0 ? 'disabled="disabled"' : '';

                        // Add quantity cell with input field
                        rowHtml += `<td class="quantity">
                                        <input type="text" size="4" 
                                            ${disabledAttr}
                                            data-quantity-original="${item.quantity || ''}" 
                                            value="${item.quantity || ''}"/>
                                </td>`;

                        // Add textarea cell if at the top level (depth 0)
                        if (depth === 0) {
                            rowHtml += `<td class="output-wrapper"><textarea class="output" rows="1" cols="50"></textarea></td>`;
                        }

                        // Close the row HTML
                        rowHtml += `</tr>`;

                        // Check if the item has sub-items and generate the sub-table row if needed
                        if (item.items) {
                            rowHtml += `<tr class="sub-table-row collapse" style="display: none;">
                                            <td colspan="3"> <!-- Adjusted colspan to 3 to include textarea -->
                                                <table class="sub-table ${subTableDepthClass}">
                                                    <tr class="table-header-row">
                                                        <th class="sub-item">Sub-Item</th>
                                                        <th class="quantity-required">Quantity Required</th>
                                                    </tr>`;

                            // Recursively create rows for sub-items
                            for (const subItem in item.items) {
                                rowHtml += createTableRow(item.items[subItem], depth + 1);
                            }

                            // Close the sub-table and row
                            rowHtml += `</table>
                                        </td>
                                    </tr>`;
                        }

                        return rowHtml;
                    }

                    // Generate table rows and append to the table body
                    for (const key in data) {
                        tableBody.innerHTML += createTableRow(data[key]);
                    }

                    // Optionally, reattach event listeners if needed
                    attachEventListeners();
                } catch (error) {
                    console.error('Error fetching data:', error);
                }
            }


            function toggleSubTable(element) {
                const icon = element.querySelector('.expand-icon');
                const row = element.closest('tr');
                const subTableRow = row.nextElementSibling;
                const outputWrapperTextarea = row.querySelector('.output-wrapper textarea');

                if (subTableRow.style.display === 'none') {
                    subTableRow.style.display = '';
                    icon.textContent = '-';
                } else {
                    subTableRow.style.display = 'none';
                    icon.textContent = '+';
                }

                // Check if the textarea exists and remove its style attribute
                if (outputWrapperTextarea) {
                    outputWrapperTextarea.removeAttribute('style');
                }
            }
        </script>

        <script>
            // Load games on page load.
            window.onload = function() {
                fetch('/discover_games')
                    .then(response => response.json())
                    .then(games => {
                        const select = document.getElementById('game-select');
                        games.forEach(game => {
                            const option = document.createElement('option');
                            option.value = game;
                            option.text = game;
                            select.add(option);
                        });
                    })
                    .catch(error => console.error('Error discovering games:', error));
            };

            async function selectGame() {
                const selectedGame = document.getElementById('game-select').value;
                
                try {
                    // Fetch the selected game data
                    const response = await fetch(`/select_game?game=${encodeURIComponent(selectedGame)}`);
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    
                    console.log('Game selected and data.json updated');
                    
                    // Optionally, reload or update the table content
                    await calculateTableList(); // Ensure this function returns a promise or is adjusted to work asynchronously

                    // Attach event listeners after updating the table
                    attachEventListeners();
                } catch (error) {
                    console.error('Error selecting game:', error);
                }
            }
        </script>

        <script>
            function loadAndAttachListeners() {
                selectGame().then(() => {
                    return calculateTableList();
                }).then(() => {
                    attachEventListeners();
                });
            }

            function attachEventListeners() {
                const quantityInputs = document.querySelectorAll('.quantity input');
                
                // Remove any previously attached event listeners (optional, but good practice)
                quantityInputs.forEach(input => {
                    input.removeEventListener('focus', updateOutput);
                    input.removeEventListener('change', updateOutput);
                });
                
                // Attach new event listeners
                quantityInputs.forEach(input => {
                    input.addEventListener('focus', updateOutput);
                    input.addEventListener('change', updateOutput);
                });
            }

            function updateOutput(event) {
                const input = event.target;
                const row = input.closest('tr');
                const subTableRow = row.nextElementSibling;

                if (subTableRow && subTableRow.classList.contains('sub-table-row')) {
                    const subTable = subTableRow.querySelector('.sub-table');
                    const subItems = subTable.querySelectorAll('tr.expandable-row, tr.no-expand');

                    // Retrieve the original quantity from the input field's parent row
                    const originalQuantity = parseInt(row.querySelector('.quantity').getAttribute('data-quantity-original') || 1);
                    const newQuantity = parseInt(input.value || 1);
                    const multiplicationFactor = newQuantity / originalQuantity;

                    let gatherItems = [];
                    let craftItems = [];

                    subItems.forEach(subItemRow => {
                        const subItemNameElement = subItemRow.querySelector('.item-name');
                        let subItemName = subItemNameElement ? subItemNameElement.textContent.trim() : 'Unknown Item';

                        // Remove leading '+' or '-' character if present
                        subItemName = subItemName.replace(/^[+-]/, '').trim();
                        
                        const subItemQuantityInput = subItemRow.querySelector('.quantity input');
                        const subItemOriginalQuantity = parseInt(subItemQuantityInput.getAttribute('data-quantity-original') || 1);
                        const adjustedQuantity = subItemOriginalQuantity * multiplicationFactor; // Adjust quantity based on the factor

                        if (subItemRow.classList.contains('expandable-row')) {
                            // Add to craft items group
                            craftItems.push(` - ${subItemName}: ${adjustedQuantity}`);
                        } else if (subItemRow.classList.contains('no-expand')) {
                            // Add to gather items group
                            const rarity = subItemRow.classList.contains('rarity-green') ? 'rarity: green' : ''; // Example for rarity, adjust as needed
                            const source = subItemNameElement.dataset.source || ''
                            const wiki = subItemNameElement.dataset.wiki || ''
                            gatherItems.push(` - ${subItemName}: ${adjustedQuantity}${rarity ? ', ' + rarity : ''}${source ? ', source: ' + source : ''}${wiki ? ', wiki: ' + wiki : ''}`);
                        }
                    });

                    // Sort the items alphabetically
                    gatherItems.sort();
                    craftItems.sort();

                    let toCraftItem = row.querySelector('.item-name').textContent.trim()
                    // Remove leading '+' or '-' character if present.
                    toCraftItem = toCraftItem.replace(/^[+-]/, '').trim();

                    const toCraftQuantity = row.querySelector('.quantity input').value;
                    const toCraftText = `To craft:\n${toCraftItem}: ${toCraftQuantity}`;
                    const gatherItemsText = `Gather these items:\n${gatherItems.join('\n')}`;
                    const craftItemsText = `Craft these intermediate items:\n${craftItems.join('\n')}`;

                    const outputTextarea = row.querySelector('.output');
                    if (outputTextarea) {
                        outputTextarea.value = `${toCraftText}\n\n${gatherItemsText}\n\n${craftItemsText}`;
                        // Auto-size the textarea
                        outputTextarea.style.height = 'auto'; // Reset height
                        outputTextarea.style.height = `${outputTextarea.scrollHeight}px`; // Set height based on content
                    }
                }
            }

        </script>
    </head>
    <body>
        <h1>Crafting Calculator GUI Live</h1>
        
        <label for="game-select">Select a game:</label>
        <select id="game-select"></select>
        <button onclick="loadAndAttachListeners();">Load Recipes</button>

        <!-- <button onclick="calculateQuantities()">Calculate</button> -->

        <table>
            <thead>
                <tr>
                    <th>Craftable Items</th>
                    <th>Quantity Required</th>
                </tr>
            </thead>
            <tbody id="js-data-table-list">
                <!-- Dynamic content will be injected here -->
            </tbody>
        </table>
    </body>
</html>
